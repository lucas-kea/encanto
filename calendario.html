<!DOCTYPE html>
<html lang="pt-br">
<!-- INSTRUÇÃO: NÃO REMOVER OU LIMPAR TAGS DUPLICADAS/REPETIDAS NESTE CÓDIGO -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Encanto Festas - Locação de Brinquedos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #003399; /* Azul Royal Profundo */
            --accent-yellow: #FFD700; /* Amarelo Ouro */
            --light-bg: #F8FAFC;
            --text-main: #1E293B;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .rounded-card { border-radius: 20px; }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px; /* Ajustado de 10px para 6px para mobile */
            width: 100%;
        }

        .day-cell {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px; /* Reduzido para mobile */
            font-size: 0.95rem; /* Reduzido de 1.1rem para mobile */
            font-weight: 700;
            position: relative;
            transition: all 0.2s;
            background: white;
            border: 2px solid #E2E8F0;
        }

        .day-cell.active:active { transform: scale(0.95); }
        
        .price-indicator {
            font-size: 0.55rem; /* Ajustado para caber em telas menores */
            font-weight: 500; 
            margin-top: 1px;
        }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 50;
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.08);
        }

        .bottom-sheet.open { transform: translateY(0); }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 51, 153, 0.2);
            z-index: 40;
            display: none;
            backdrop-filter: blur(4px);
        }

        .availability-bar-container {
            position: relative;
            padding-top: 8px;
        }

        .availability-bar {
            height: 12px;
            background: linear-gradient(90deg, #22C55E 0%, #EAB308 50%, #EF4444 100%);
            border-radius: 20px;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .toy-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        
        .toy-card:hover { transform: translateY(-2px); }

        .toy-card.disabled {
            opacity: 0.35 !important;
            filter: grayscale(1) !important;
            pointer-events: none !important;
        }

        .age-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 800;
            color: white;
            z-index: 5;
        }

        .img-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-primary {
            background-color: var(--accent-yellow);
            color: var(--primary-blue);
            font-weight: 700;
            box-shadow: 0 4px 0 #D4AF37;
            transition: all 0.1s;
        }
        
        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #D4AF37;
        }

        .toggle-switch {
            width: 34px;
            height: 18px;
            background: #CBD5E1;
            border-radius: 20px;
            position: relative;
            transition: 0.3s;
        }
        .toggle-switch.on { background: var(--primary-blue); }
        .toggle-knob {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: 0.3s;
        }
        .toggle-switch.on .toggle-knob { left: 19px; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .border-error { border: 2px solid #EF4444 !important; }
        .border-success { border: 2px solid #22C55E !important; }

        #cartToast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #1E293B;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            width: fit-content;
            white-space: nowrap;
        }
        #cartToast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #streetSuggestionsContainer {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-top: -12px;
            margin-bottom: 16px;
            border: 1px solid #F1F5F9;
            overflow: hidden;
            display: none;
        }
        .suggestion-item {
            padding: 14px 20px;
            font-size: 13px;
            font-weight: 500;
            border-bottom: 1px solid #F8FAFC;
            cursor: pointer;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background: #F1F5F9; }
    </style>
</head>
<body class="pb-32 bg-slate-50">

    <div id="cartToast">Adicionado ao carrinho</div>

    <header class="pt-24 pb-4 text-center bg-white border-b border-slate-50">
        <h1 class="text-2xl font-bold text-[#003399] tracking-tight">Escolha a data</h1>
    </header>

    <main class="px-3 sm:px-5">
        <div class="bg-white rounded-[24px] p-4 sm:p-6 shadow-sm border border-slate-100 mt-2 min-h-[400px]">
            <div id="calendarLoader" class="hidden flex flex-col items-center justify-center py-20">
                <div class="w-10 h-10 border-4 border-[#003399] border-t-transparent rounded-full animate-spin"></div>
                <p class="text-[10px] font-bold text-slate-400 mt-6 uppercase tracking-widest text-center">Verificando brinquedos disponíveis</p>
            </div>

            <div id="calendarContent">
                <div class="flex justify-between items-center mb-8">
                    <button onclick="changeMonth(-1)" class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full bg-slate-50 text-[#003399]"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="currentMonthLabel" class="font-bold text-[#003399] text-base sm:text-xl tracking-tight uppercase">...</h2>
                    <button onclick="changeMonth(1)" class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full bg-slate-50 text-[#003399]"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="calendar-grid mb-6" id="calendarGrid"></div>

                <div class="space-y-1 pt-4 border-t border-slate-50">
                    <div class="flex justify-between items-center text-[10px] uppercase font-bold tracking-wider mb-2">
                        <span class="text-green-600">Muitos Brinquedos</span>
                        <span class="text-red-500">Poucas Vagas</span>
                    </div>
                    <div class="availability-bar-container">
                        <div class="availability-bar" style="background: linear-gradient(90deg, #22C55E 0%, #EAB308 50%, #EF4444 100%)"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 h-10"></div>
    </main>

    <div class="overlay" id="overlay" onclick="closeSheet()"></div>
    
    <div class="bottom-sheet" id="toySheet">
        <div class="sticky top-0 bg-white z-10 p-6 pb-2">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-base font-bold text-[#003399] tracking-tight" id="toySheetTitle">Disponíveis em ...</h3>
                    <p id="priceLevelLabel" class="text-[11px] font-bold mt-1 leading-tight"></p>
                </div>
                <button onclick="closeSheet()" class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
            </div>

            <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar">
                <select id="sortFilter" onchange="renderToys()" class="p-3 bg-slate-100 rounded-xl text-xs font-bold outline-none border-none">
                    <option value="relevance">RELEVÂNCIA</option>
                    <option value="az">NOME A-Z</option>
                </select>
                <select id="ageFilter" onchange="renderToys()" class="p-3 bg-slate-100 rounded-xl text-xs font-bold outline-none border-none">
                    <option value="all">TODAS IDADES</option>
                    <option value="L">LIVRE</option>
                    <option value="-6">ATÉ 6 ANOS</option>
                    <option value="-14">ATÉ 14 ANOS</option>
                </select>
            </div>
        </div>

        <div class="px-6 pb-40">
            <div id="toyList" class="grid grid-cols-1 gap-4"></div>
        </div>
    </div>

    <div class="bottom-sheet" id="formSheet">
        <div class="p-6">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6"></div>
            <div id="formContent" class="pb-32"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-slate-100 p-5 z-[60] flex flex-col gap-3 transition-all transform translate-y-0" id="summaryFooter">
        <div class="flex justify-between items-end px-1">
            <div class="flex flex-col">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">TOTAL</span>
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-[#003399]" id="totalValueText">R$ 0,00</span>
                    <span id="discountBadge" class="hidden ml-2 bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-lg font-black shadow-sm">COMBO</span>
                </div>
                <span id="savingsText" class="hidden text-[9px] text-green-500 font-bold leading-none mt-1">Você economizou R$ 0,00</span>
            </div>
            <div class="text-right">
                <span id="deliveryText" class="text-[10px] font-bold uppercase tracking-tighter"></span>
            </div>
        </div>
        <button id="mainBtn" onclick="nextStep()" class="w-full btn-primary py-4 rounded-2xl text-lg shadow-xl active:scale-95 transition-all uppercase">
            Continuar
        </button>
    </div>

    <div id="pixPopup" class="fixed inset-0 bg-[#003399]/40 backdrop-blur-sm flex items-center justify-center z-[200] hidden p-6">
        <div class="bg-white p-8 rounded-[32px] text-center w-full max-sm shadow-2xl">
            <div class="w-20 h-20 bg-green-500 text-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-calendar-check text-3xl"></i>
            </div>
            <h4 class="text-2xl font-black text-slate-800 mb-2">Reservado!</h4>
            <p class="text-slate-500 text-sm mb-2 leading-relaxed">Para manter sua reserva, pedimos um pequeno sinal de <b>R$ 25,00</b> e o restante no dia da montagem.</p>
            
            <div class="bg-blue-50/50 py-3 px-4 rounded-2xl mb-6 inline-block">
                <p class="text-[10px] font-black text-[#003399] uppercase tracking-widest mb-1">VALOR TOTAL</p>
                <p class="text-[#003399] font-black text-3xl tracking-tighter" id="pixFinalTotalDisplay">R$ 0,00</p>
            </div>
            
            <div class="bg-slate-50 p-4 rounded-2xl mb-6 border-2 border-dashed border-slate-200 relative">
                <span class="absolute -top-3 left-4 bg-white px-2 text-[10px] font-bold text-slate-400">CNPJ PIX</span>
                <code class="text-blue-900 font-mono font-bold" id="pixKey">57.545.647/0001-16</code>
            </div>

            <button id="pixBtn" onclick="copyPixOnly()" class="w-full btn-primary py-4 rounded-2xl mb-4 uppercase">COPIAR CHAVE PIX</button>
            <button onclick="location.reload()" class="text-slate-400 text-xs font-bold uppercase tracking-widest">Sair</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwSwpXlkkpH2owVoc4EqroYjVSCJ3A20o16ataeEK9TMEn-VaMeAfoBothCwIKwwfyU/exec"; 
        
        let currentDate = new Date();
        let selectedDate = null;
        let sheetData = [];
        let streetList = []; 
        let globalAgendamentos = {}; 
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let cart = [];
        let currentStep = 'calendar';
        let insuranceEnabled = false; 
        let selectedBairro = null;
        let extraDays = 1;
        let startTime = "09:00";
        let endTime = "15:00"; 
        let monitorsCount = 0;
        let monitorHours = 2;
        let rainInfo = "não molha nada";
        let piscinaCovered = "não"; 
        let deliveryPreviousDay = false;
        let socketDistances = {};
        let couponCode = "";
        let couponIsValid = false;
        
        var userName = "";
        var userZap = "";
        var userRua = "";
        var userNum = "";
        var userSN = false;
        var userDetails = "";
        var userObs = "";
        var needsInvoice = false;
        var userCNPJ = "";
        var userCEP = "";

        const COUPONS_DB = {
            "FRETE10": "R$ 15,00 de desconto no frete aplicado!",
            "MIXCASTLE": "Castelinho por R$ 180,00 aplicado!",
            "MEGAPROMO": "20% de desconto aplicado!",
            "ENCANTO": "10% de desconto aplicado!",
            "CLUBEDEZ": "10% de desconto aplicado!",
            "DESCONTO1": "1% de desconto aplicado!",
            "DESCONTO2": "2% de desconto aplicado!",
            "DESCONTO3": "3% de desconto aplicado!",
            "DESCONTO4": "4% de desconto aplicado!",
            "DESCONTO5": "5% de desconto aplicado!",
            "DESCONTO6": "6% de desconto aplicado!",
            "DESCONTO7": "7% de desconto aplicado!",
            "DESCONTO8": "8% de desconto aplicado!",
            "DESCONTO9": "9% de desconto aplicado!",
            "DESCONTO10": "10% de desconto aplicado!"
        };

        const TOYS_DB = [
            { id: 1, name: "Pula Pula Pequeno", qty: 1, price: 170, category: "pula", age: "14", size: "2.4m", power: false, relevance: 1, photo: "https://www.dropbox.com/scl/fi/el5jqaoyod5ukwwzaxihx/camap.webp?rlkey=y1zvmsi9cdtsbh3gtb3091a4x&st=bpwuda61&raw=1" },
            { id: 2, name: "Pula Pula Médio", qty: 3, price: 190, category: "pula", age: "14", size: "3.0m", power: false, relevance: 2, photo: "https://www.dropbox.com/scl/fi/2xwplyqsnbhndgwde2scg/camam.webp?rlkey=41hiqdgiwnxzvmllf0owgckx8&st=g35vk0oj&raw=1" },
            { id: 3, name: "Piscina de Bolinhas", qty: 2, price: 160, category: "piscina", age: "14", size: "2.0m", power: false, relevance: 3, photo: "https://www.dropbox.com/scl/fi/pr90on1ea81nq30lzpxr8/piscina.webp?rlkey=mp5a9b4yfk5v0tyqt75g0ij2j&st=gp4p2onk&raw=1" },
            { id: 4, name: "Tobogã Médio", qty: 1, price: 400, category: "toboga", age: "14", size: "5.0m", power: true, motorForte: true, relevance: 4, photo: "https://www.dropbox.com/scl/fi/a673dgh39ak497b6h9e2t/tobogam.webp?rlkey=byhi3k1tklmum2sfq9fyor2rb&st=rz9ming4&raw=1" },
            { id: 5, name: "Área Baby", qty: 1, price: 120, category: "baby", age: "6", size: "3x3m", power: false, relevance: 5, photo: "https://www.dropbox.com/scl/fi/fttgp8j0mjdhw22rwgr3i/areababy.webp?rlkey=028cvlshetwv4w7dm3aydbzwj&st=7kmq57d2&raw=1" },
            { id: 6, name: "Mini Baby", qty: 1, price: 220, category: "baby", age: "6", size: "2.5m", power: true, relevance: 6, photo: "https://www.dropbox.com/scl/fi/178cc2igiy3y5wchnseum/minibaby.webp?rlkey=7svoyh1p0tggjsjehqhaegpt&st=9zacigwz&raw=1" },
            { id: 7, name: "Castelinho", qty: 1, price: 220, category: "baby", age: "14", size: "3.0m", power: true, relevance: 7, photo: "https://www.dropbox.com/scl/fi/zn1npqidyhre44o7v1nwr/castelinho.webp?rlkey=8765usqe385cii48inuz99e5j&st=5q2xu57k&raw=1" },
            { id: 8, name: "Futebol de Sabão", qty: 1, price: 600, category: "especial", age: "14", size: "10.0m", power: true, motorForte: true, relevance: 8, photo: "https://www.dropbox.com/scl/fi/iceod32yym2tttljajh8e/futebol.webp?rlkey=qttzkj74om9j8uyov770cvkdn&st=10wsk8x8&raw=1" },
            { id: 9, name: "Escorrega com Bolinhas", qty: 1, price: 400, category: "especial", age: "14", size: "4.0m", power: true, motorForte: true, relevance: 9, photo: "https://www.dropbox.com/scl/fi/vqjds36sx0wvhjuxurc4l/escorregobol.webp?rlkey=qxk7tzac8xod1fdzrwr8u508m&st=59u3k5x9&raw=1" },
            { id: 10, name: "Airhockey", qty: 1, price: 200, category: "mesa_jogo", age: "L", size: "1.5m", power: true, relevance: 10, photo: "https://www.dropbox.com/scl/fi/ajfbj633cif6lpupadding_rw/aero.webp?rlkey=hw3hlemgizrnj4ta2fkrcs1ep&st=33j7lib0&raw=1" },
            { id: 11, name: "Pebolim", qty: 1, price: 200, category: "mesa_jogo", age: "L", size: "1.4m", power: false, relevance: 11, photo: "https://www.dropbox.com/scl/fi/bx7605s0ls33k02y74t4j/pebolim.webp?rlkey=409zdmagm2yj6ao6g4mfhfquj&st=j6elwlyz&raw=1" },
            { id: 12, name: "Pingpong", qty: 1, price: 200, category: "mesa_jogo", age: "L", size: "2.7m", power: false, relevance: 12, photo: "https://www.dropbox.com/scl/fi/3ulqvdy513l94frbqa99p/pingpong.webp?rlkey=zwzys2yjemczin4ebi3c22jq8&st=w8pcvikq&raw=1" },
            { id: 13, name: "Mesas", qty: 4, price: 15, category: "mesa_comer", age: "L", size: "0.8m", power: false, relevance: 13, photo: "https://www.dropbox.com/scl/fi/zpcyj8a466fhms7vqwcr6/mesas.webp?rlkey=8ca2hbxbnvxbftagrprq7scj7&st=bb24hbti&raw=1" }
        ];

        const totalEstoqueGlobal = TOYS_DB.reduce((acc, toy) => acc + toy.qty, 0);

        const BAIRROS = {
            "Acaraí": 0, "Água Branca": 0, "Capri": 10, "Centro": 0, "Centro Histórico": 0,
            "Enseada": 10, "Ervino": 25, "Iperoba": 0, "Itaguaçu": 10, "Laranjeiras": 10,
            "Majorca": 10, "Miranda": 10, "Morro Grande": 0, "Paulas": 0, "Praia Grande": 10,
            "Reta": 0, "Ribeira": 10, "Rocio Grande": 0, "Rocio Pequeno": 0, "Sandra Regina": 10,
            "Tapera": 10, "Ubatuba": 10, "Vila da Glória": -1
        };

        window.onload = async () => {
            currentMonth = new Date().getMonth();
            currentYear = new Date().getFullYear();
            renderCalendar();
            fetchData();
            loadStreets();
            document.getElementById('summaryFooter').style.display = 'none';
        };

        async function loadStreets() {
            try {
                const response = await fetch('ruas.json');
                if (response.ok) streetList = await response.json();
            } catch (e) {
                console.warn("Arquivo ruas.json não encontrado.");
            }
        }

        function normalizeDate(val) {
            if (!val) return "";
            if (val instanceof Date) return `${String(val.getDate()).padStart(2,'0')}/${String(val.getMonth()+1).padStart(2,'0')}/${val.getFullYear()}`;
            let s = String(val).trim();
            if (!s || s.toLowerCase() === "undefined") return "";
            let datePart = s.split(' ')[0].split('T')[0]; 
            let d, m, y;
            if (datePart.includes('/')) {
                let p = datePart.split('/');
                if (p[0].length === 4) { y = p[0]; m = p[1]; d = p[2]; }
                else { d = p[0]; m = p[1]; y = p[2]; }
            } else if (datePart.includes('-')) {
                let p = datePart.split('-');
                if (p[0].length === 4) { y = p[0]; m = p[1]; d = p[2]; }
                else { d = p[0]; m = p[1]; y = p[2]; }
            } else return datePart;
            return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
        }

        async function fetchData() {
            if (!API_URL) return;
            const loader = document.getElementById('calendarLoader');
            const content = document.getElementById('calendarContent');
            try {
                loader.classList.remove('hidden');
                content.classList.add('hidden');
                const res = await fetch(API_URL);
                const data = await res.json();
                sheetData = Array.isArray(data) ? data : [];
                const mapNomeId = {};
                TOYS_DB.forEach(b => {
                    mapNomeId[b.name.toLowerCase()] = b.id;
                    if(b.name.toLowerCase().includes("pula pula")) mapNomeId[b.name.toLowerCase().replace("pula pula", "cama elástica")] = b.id;
                });
                const novosAgendamentos = {};
                sheetData.forEach(row => {
                    const dateISO = normalizeDate(row['EVENTO'] || row['INICIO']);
                    if (!dateISO) return;
                    if (!novosAgendamentos[dateISO]) novosAgendamentos[dateISO] = {};
                    const itensStr = row['ITENS LOCADOS'] || row['BRINQUEDO'];
                    if (itensStr) {
                        const linhas = String(itensStr).split(/[,\n;]/);
                        linhas.forEach(linha => {
                            const match = linha.trim().match(/(?:•\s*)?(\d+)\s*x\s*(.+)/i);
                            if (match) {
                                const qtd = parseInt(match[1]);
                                const nomeLimpo = match[2].trim().toLowerCase();
                                const id = mapNomeId[nomeLimpo] || TOYS_DB.find(t => nomeLimpo.includes(t.name.toLowerCase()))?.id;
                                if (id) novosAgendamentos[dateISO][id] = (novosAgendamentos[dateISO][id] || 0) + qtd;
                            } else {
                                const nomeSozinho = linha.trim().toLowerCase();
                                const id = TOYS_DB.find(t => nomeSozinho.includes(t.name.toLowerCase()))?.id;
                                if (id) novosAgendamentos[dateISO][id] = (novosAgendamentos[dateISO][id] || 0) + 1;
                            }
                        });
                    }
                });
                globalAgendamentos = novosAgendamentos;
                renderCalendar();
                loader.classList.add('hidden');
                content.classList.remove('hidden');
            } catch (e) {
                loader.classList.add('hidden');
                content.classList.remove('hidden');
                renderCalendar();
            }
        }

        function changeMonth(dir) {
            const today = new Date();
            const minDate = new Date(today.getFullYear(), today.getMonth(), 1);
            const maxDate = new Date(today.getFullYear(), today.getMonth() + 12, 1);
            let nextM = currentMonth + dir;
            let nextY = currentYear;
            if (nextM < 0) { nextM = 11; nextY--; }
            if (nextM > 11) { nextM = 0; nextY++; }
            const nextDate = new Date(nextY, nextM, 1);
            if (nextDate < minDate || nextDate > maxDate) return;
            currentMonth = nextM; currentYear = nextY;
            renderCalendar();
        }

        function getPriceLevel(date) {
            if (!date) return '$';
            const d = date.getDate();
            const m = date.getMonth() + 1;
            const dayOfWeek = date.getDay();
            const s = `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}`;
            if (["01/01", "01/05", "07/09", "12/10", "02/11", "15/11", "25/12"].includes(s)) return '$$$$';
            const sBase = ["01/04", "31/12", "05/10", "12/10", "12/07", "31/08", "11/10", "29/06", "06/07", "20/07", "09/11", "07/06", "21/06", "28/06", "13/07", "02/08", "16/08", "17/08", "06/09", "13/09", "20/09", "28/09", "19/10", "26/10"];
            if (sBase.includes(s)) return '$$$';
            return (dayOfWeek === 0 || dayOfWeek === 6) ? '$$' : '$';
        }

        function getDayColorStyle(date) {
            const dateStr = normalizeDate(date);
            const agendados = globalAgendamentos[dateStr] || {};
            let locados = 0;
            Object.values(agendados).forEach(v => locados += v);
            if (locados === 0) return 'background-color: #22C55E; color: white;';
            const ratio = Math.min(locados / totalEstoqueGlobal, 1);
            const r = Math.round(34 + (239 - 34) * ratio);
            const g = Math.round(197 + (68 - 197) * ratio);
            const b = Math.round(94 + (68 - 94) * ratio);
            return `background-color: rgb(${r}, ${g}, ${b}); color: white; border: 2px solid rgba(255,255,255,0.4); box-shadow: 0 4px 10px rgba(0,0,0,0.1);`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const label = document.getElementById('currentMonthLabel');
            if (!grid || !label) return;
            label.innerText = `${["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"][currentMonth]} ${currentYear}`;
            grid.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) grid.innerHTML += '<div></div>';
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(currentYear, currentMonth, d);
                const isPast = date < today;
                const styleStr = isPast ? 'opacity: 0.4; pointer-events: none;' : getDayColorStyle(date);
                const borderClass = date.getTime() === today.getTime() ? 'border-[#003399] border-4' : '';
                const cell = document.createElement('div');
                cell.className = `day-cell active ${borderClass} ${isPast ? '' : 'cursor-pointer'}`;
                cell.style = styleStr;
                cell.innerHTML = `<span class="font-bold">${d}</span><span class="price-indicator" style="color: rgba(255,255,255,0.8)">${getPriceLevel(date)}</span>`;
                if (!isPast) cell.onclick = () => selectDate(date);
                grid.appendChild(cell);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('cartToast');
            if (t) { 
                t.innerText = msg; 
                t.classList.add('show'); 
                setTimeout(() => t.classList.remove('show'), 2000); 
            }
        }

        function selectDate(date) {
            selectedDate = date; currentStep = 'toys'; openSheet('toySheet');
            document.getElementById('toySheetTitle').innerText = `Disponíveis em ${normalizeDate(date)}`;
            const pl = getPriceLevel(date);
            const plLabel = document.getElementById('priceLevelLabel');
            if (pl === '$') plLabel.innerHTML = `<span class="text-green-600 font-black">Data pouco requisitada</span><br><span class="text-[10px] text-green-500 font-black uppercase">PREÇOS MAIS BAIXO QUE O NORMAL</span>`;
            else if (pl === '$$') plLabel.innerHTML = `<span class="text-slate-400 font-black uppercase">Data Padrão</span>`;
            else if (pl === '$$$') plLabel.innerHTML = `<span class="text-yellow-600 font-black">Data bem procurada</span><br><span class="text-[10px] text-yellow-500 font-black uppercase">VALORES UM POUCO MAIS ALTO QUE O NORMAL</span>`;
            else if (pl === '$$$$') plLabel.innerHTML = `<span class="text-orange-600 font-black">Data com alta demanda</span><br><span class="text-[10px] text-orange-500 font-black uppercase">VALORES BEM MAIS ALTO QUE O NORMAL</span>`;
            cart = []; renderToys(); updateSummary();
            document.getElementById('summaryFooter').style.display = 'flex';
        }

        function openSheet(id) { 
            const overlay = document.getElementById('overlay');
            const sheet = document.getElementById(id);
            if(overlay) overlay.style.display = 'block'; 
            if(sheet) {
                sheet.classList.add('open');
                sheet.scrollTop = 0; // Garante que abre no topo
            }
            document.body.style.overflow = 'hidden'; 
        }
        function closeSheet() { document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('open')); document.getElementById('overlay').style.display = 'none'; document.body.style.overflow = 'auto'; }

        function getToyStockForDate(toyId, dateStr) {
            const toyBase = TOYS_DB.find(t => t.id === toyId);
            const totalReservadoNoDia = (globalAgendamentos[dateStr] || {})[toyId] || 0;
            return Math.max(0, toyBase.qty - totalReservadoNoDia);
        }

        function renderToys() {
            const list = document.getElementById('toyList');
            const dateStr = normalizeDate(selectedDate);
            const motorGrandeNames = ["Tobogã Médio", "Futebol de Sabão", "Escorrega com Bolinhas"];
            const isMotorGrandeBooked = motorGrandeNames.some(n => {
                const tObj = TOYS_DB.find(t=>t.name===n);
                return tObj && (globalAgendamentos[dateStr] || {})[tObj.id] > 0;
            });
            const cartHasMotorGrande = cart.some(c => motorGrandeNames.includes(c.name));
            let toys = [...TOYS_DB].map(toy => ({ ...toy, availableQty: getToyStockForDate(toy.id, dateStr) }));
            const ageF = document.getElementById('ageFilter').value;
            const sort = document.getElementById('sortFilter').value;
            if (ageF !== 'all') toys = toys.filter(t => t.age === ageF.replace('-', ''));
            if (sort === 'az') toys.sort((a,b) => a.name.localeCompare(b.name));
            else toys.sort((a,b) => a.relevance - b.relevance);

            const pl = getPriceLevel(selectedDate);
            let mult = pl==='$' ? 0.8 : (pl==='$$$' ? 1.2 : (pl==='$$$$' ? 1.6 : 1.0));

            list.innerHTML = '';
            toys.forEach(toy => {
                const inCart = cart.find(c => c.id === toy.id) || { qty: 0 };
                let isOut = toy.availableQty <= 0 && inCart.qty === 0;
                let isMotorLock = motorGrandeNames.includes(toy.name) && (isMotorGrandeBooked || (cartHasMotorGrande && inCart.qty === 0));
                let isBlocked = isOut || isMotorLock;
                
                // Mesas não sofrem plMult
                let price = (toy.category === 'mesa_comer') ? toy.price : toy.price * mult;
                
                const card = document.createElement('div');
                card.className = `toy-card flex p-4 relative ${isBlocked ? 'disabled' : ''}`;
                
                card.innerHTML = `
                    <div class="w-20 h-20 rounded-xl overflow-hidden mr-4 shrink-0 bg-slate-100 flex items-center justify-center relative img-skeleton">
                        <img src="${toy.photo}" class="w-full h-full object-cover opacity-0 transition-opacity duration-300" onload="this.classList.remove('opacity-0'); this.parentElement.classList.remove('img-skeleton')"><div class="age-badge bg-blue-500">${toy.age}</div>
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800 text-sm leading-tight uppercase font-black">${toy.name}</h4>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase font-semibold">${toy.size}</p>
                        <p class="${mult < 1.0 && toy.category !== 'mesa_comer' ? 'text-green-500' : (mult > 1.0 && toy.category !== 'mesa_comer' ? 'text-red-500' : 'text-[#003399]')} font-black mt-1">R$ ${price.toLocaleString('pt-BR', {minimumFractionDigits: 0})}</p>
                        <div class="flex items-center mt-2 gap-3">
                            <button onclick="changeQty(${toy.id}, -1)" class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 border border-slate-100">-</button>
                            <span class="font-bold text-sm w-4 text-center font-black">${inCart.qty}</span>
                            <button onclick="changeQty(${toy.id}, 1)" class="w-8 h-8 rounded-full bg-[#003399] text-white flex items-center justify-center">+</button>
                        </div>
                    </div>`;
                list.appendChild(card);
            });
        }

        function changeQty(id, delta) {
            const dateStr = normalizeDate(selectedDate);
            const toy = TOYS_DB.find(t => t.id === id);
            const realStockAvailable = getToyStockForDate(toy.id, dateStr);
            let item = cart.find(c => c.id === id);
            if (!item && delta > 0) { 
                if(realStockAvailable > 0) { 
                    cart.push({ ...toy, qty: 1 }); 
                    showToast("Adicionado ao carrinho"); 
                } 
            }
            else if (item) {
                let oldQty = item.qty;
                item.qty = Math.max(0, Math.min(item.qty + delta, realStockAvailable));
                if (item.qty > oldQty) showToast("Adicionado ao carrinho");
                if (item.qty < oldQty) showToast("Retirado do carrinho");
                if (item.qty === 0) cart = cart.filter(c => c.id !== id);
            }
            renderToys(); updateSummary();
        }

        function updateSummary() {
            let totalBrinquedos = 0;
            let fullPriceTotal = 0;
            const pl = getPriceLevel(selectedDate);
            let plMult = pl==='$' ? 0.8 : (pl==='$$$' ? 1.2 : (pl==='$$$$' ? 1.6 : 1.0));
            let countCombo = 0;
            cart.forEach(i => {
                let priceItem = (i.category === 'mesa_comer') ? i.price : i.price * plMult;
                if (couponCode === "MIXCASTLE" && i.id === 7) priceItem = 180;
                totalBrinquedos += priceItem * i.qty;
                fullPriceTotal += i.price * i.qty * extraDays;
                if (i.category !== 'mesa_comer') countCombo += i.qty;
            });
            let comboDiscount = 1.0;
            const badge = document.getElementById('discountBadge');
            if (countCombo >= 2) {
                const discPerc = pl === '$' ? 5 : 10;
                comboDiscount = pl === '$' ? 0.95 : 0.90;
                badge.innerText = `COMBO ${discPerc}%!`;
                badge.classList.remove('hidden');
            } else badge.classList.add('hidden');
            totalBrinquedos *= comboDiscount;
            let multDays = [1, 1, 1.7, 2.3, 2.8, 3.2][extraDays] || 1;
            let totalFinal = totalBrinquedos * multDays;
            let startInt = parseInt(startTime.split(':')[0]);
            let isNextDay = endTime === "NEXT_DAY";
            let endInt = isNextDay ? 22 : parseInt(endTime.split(':')[0]);
            let duration = endInt - startInt;
            if (duration > 6) totalFinal += (duration - 6) * 5;
            if (isNextDay) totalFinal += 10;
            let monitorTotal = monitorsCount * monitorHours * 30;
            totalFinal += monitorTotal;
            let deliveryFee = (selectedBairro ? BAIRROS[selectedBairro] : 0);
            if (couponCode === "FRETE10" && deliveryFee > 0) deliveryFee = Math.max(0, deliveryFee - 15);
            totalFinal += (insuranceEnabled ? 14.90 : 0) + deliveryFee;
            if (couponIsValid) {
                if (couponCode === "MEGAPROMO") totalFinal *= 0.8;
                else if (couponCode.startsWith("DESCONTO")) {
                    let perc = parseInt(couponCode.replace("DESCONTO", ""));
                    if (!isNaN(perc)) totalFinal *= (1 - perc/100);
                }
                else if (COUPONS_DB[couponCode] && COUPONS_DB[couponCode].includes("10%")) totalFinal *= 0.9;
            }
            const totalStr = "R$ " + totalFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            document.getElementById('totalValueText').innerText = totalStr;
            document.getElementById('pixFinalTotalDisplay').innerText = totalStr;
            let savings = Math.max(0, fullPriceTotal - totalFinal);
            const savingsEl = document.getElementById('savingsText');
            if (savings > 1) {
                savingsEl.innerText = `Você economizou R$ ${savings.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                savingsEl.classList.remove('hidden');
            } else savingsEl.classList.add('hidden');
            const delEl = document.getElementById('deliveryText');
            if (selectedBairro) delEl.innerHTML = deliveryFee === 0 ? '<span class="text-green-500 font-black">FRETE GRÁTIS</span>' : `TAXA R$ ${deliveryFee.toFixed(2).replace('.',',')}`;
            else delEl.innerText = "";
            document.getElementById('mainBtn').disabled = cart.length === 0;
            if (currentStep === 'summary') {
                const list = document.getElementById('orderDetailList');
                if (list) list.innerHTML = cart.map(i => `<div class='text-slate-800 font-bold py-0.5 text-sm uppercase font-black'>${i.qty}x ${i.name}</div>`).join('');
            }
        }

        async function sendToSheet() {
            if (!API_URL) return;
            const payload = {
                id: "ID",
                evento: normalizeDate(selectedDate),
                diaAnt: deliveryPreviousDay ? "Sim" : "Não",
                inicio: startTime,
                termino: endTime === "NEXT_DAY" ? "Dia Seg." : endTime,
                nome: userName,
                whatsapp: userZap,
                bairro: selectedBairro,
                rua: userRua,
                num: userSN ? "S/N" : userNum,
                pontoRef: userDetails,
                itens: cart.map(i => `${i.qty}x ${i.name}`).join("\n"),
                cobert: piscinaCovered,
                monitores: monitorsCount > 0 ? `${monitorsCount} Mon. (${monitorHours}h)` : "Não",
                extensao: Object.entries(socketDistances).map(([id, dist]) => {
                    const toy = TOYS_DB.find(t => t.id == id);
                    return toy ? `${toy.name}: ${dist}m` : `${dist}m`;
                }).join("\n"),
                seguro: insuranceEnabled ? "Sim" : "Não",
                nota: needsInvoice ? "Sim" : "Não",
                diaria: extraDays,
                pago: "",
                total: document.getElementById('totalValueText').innerText,
                obs: "",
                cnpj: userCNPJ,
                cep: userCEP
            };
            
            try { 
                await fetch(API_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                }); 
            } catch (e) {
                console.error("Erro ao enviar:", e);
            }
        }

        function copyPixOnly() {
            const el = document.createElement('textarea'); el.value = "57545647000116"; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            document.getElementById('pixBtn').innerText = "COPIADO!";
        }

        function handleStreetInput(i) {
            let val = i.value;
            let vFormatted = val.toLowerCase().replace(/(^\w|\s\w)/g, m => m.toUpperCase());
            i.value = vFormatted; window.userRua = vFormatted;
            const ghost = document.getElementById('userRuaGhost');
            const container = document.getElementById('streetSuggestionsContainer');
            if (vFormatted.length < 4) {
                if(ghost) ghost.value = "";
                container.style.display = 'none';
                return;
            }
            const match = streetList.find(s => s.toLowerCase().startsWith(vFormatted.toLowerCase()));
            if (match) {
                if(ghost) ghost.value = vFormatted + match.substring(vFormatted.length);
                const matches = streetList.filter(s => s.toLowerCase().includes(vFormatted.toLowerCase())).slice(0, 3);
                container.innerHTML = matches.map(s => `<div class="suggestion-item" onclick="selectStreet('${s}')">${s}</div>`).join('');
                container.style.display = 'block';
            } else {
                if(ghost) ghost.value = "";
                container.style.display = 'none';
            }
        }

        function selectStreet(s) { 
            window.userRua = s; 
            const inp = document.getElementById('userRua');
            const ghost = document.getElementById('userRuaGhost');
            if(inp) inp.value = s; 
            if(ghost) ghost.value = "";
            document.getElementById('streetSuggestionsContainer').style.display = 'none'; 
        }

        function handleStreetKeydown(e) {
            const ghost = document.getElementById('userRuaGhost');
            if ((e.key === 'Enter' || e.key === 'Tab' || e.key === 'ArrowRight') && ghost && ghost.value !== "") {
                e.preventDefault();
                selectStreet(ghost.value);
            }
        }

        function validateCurrentStep() {
            document.querySelectorAll('input, select, textarea').forEach(el => {
                if(el) el.classList.remove('border-error');
            });
            
            if (currentStep === 'toys' && cart.length === 0) { showToast("Selecione um item!"); return false; }
            if (currentStep === 'id') {
                const elName = document.getElementById('userName');
                const elZap = document.getElementById('userZap');
                if (!userName || userName.trim().length < 2) { if(elName) elName.classList.add('border-error'); return false; }
                if (!userZap || userZap.length < 15) { if(elZap) elZap.classList.add('border-error'); return false; }
            } else if (currentStep === 'address') {
                const elBairro = document.getElementById('userBairro');
                const elRua = document.getElementById('userRua');
                const elNum = document.getElementById('userNum');
                const elDet = document.getElementById('userDetails');
                if (!selectedBairro) { if(elBairro) elBairro.classList.add('border-error'); return false; }
                if (!userRua || userRua.trim().length < 3) { if(elRua) elRua.classList.add('border-error'); return false; }
                if (!userSN && !userNum) { if(elNum) elNum.classList.add('border-error'); return false; }
                if (!userDetails || userDetails.trim().length < 2) { if(elDet) elDet.classList.add('border-error'); return false; }
                if (selectedBairro === "Ervino") {
                    const checkStr = (userRua + " " + userDetails).toUpperCase();
                    if (checkStr.includes("TWO")) {
                        const modal = document.createElement('div');
                        modal.className = "fixed inset-0 bg-black/60 z-[300] flex items-center justify-center p-6";
                        modal.innerHTML = `<div class="bg-white p-8 rounded-3xl text-center shadow-2xl max-w-xs"><i class="fas fa-exclamation-triangle text-orange-500 text-4xl mb-4"></i><p class="font-bold text-slate-800 font-black">Não entregamos no Bar da Two, por motivos internos.</p><button onclick="this.parentElement.parentElement.remove()" class="mt-6 w-full btn-primary py-3 rounded-xl uppercase">Entendido</button></div>`;
                        document.body.appendChild(modal);
                        return false;
                    }
                }
            }
            return true;
        }

        function nextStep() {
            if (!validateCurrentStep()) return;
            const steps = ['toys', 'id', 'address', 'party', 'details', 'summary'];
            const idx = steps.indexOf(currentStep);
            
            if (currentStep === 'summary') { 
                sendToSheet(); 
                document.getElementById('pixPopup').classList.remove('hidden'); 
                return; 
            }
            
            const next = steps[idx + 1];
            if (next) {
                currentStep = next;
                closeSheet(); 
                setTimeout(() => { 
                    openSheet('formSheet'); 
                    renderForm(); 
                }, 200);
            }
        }

        function formatName(i) { 
            let v = i.value.replace(/[0-9]/g, "").toLowerCase().replace(/(^\w|\s\w)/g, m => m.toUpperCase());
            i.value = v; userName = v; 
        }

        function maskCNPJ(i) { 
            let v = i.value.replace(/\D/g, "").slice(0, 14); 
            let m = ""; 
            if (v.length > 0) m = v.substring(0, 2); 
            if (v.length > 2) m += "." + v.substring(2, 5); 
            if (v.length > 5) m += "." + v.substring(5, 8); 
            if (v.length > 8) m += "/" + v.substring(8, 12); 
            if (v.length > 12) m += "-" + v.substring(12, 14); 
            i.value = m; userCNPJ = m; 
        }

        function maskCEP(i) { 
            let v = i.value.replace(/\D/g, "").slice(0, 8); 
            let m = ""; 
            if (v.length > 0) m = v.substring(0, 2); 
            if (v.length > 2) m += "." + v.substring(2, 5); 
            if (v.length > 5) m += "-" + v.substring(5, 8); 
            i.value = m; userCEP = m; 
        }

        function maskZap(i) { let v = i.value.replace(/\D/g, "").slice(0, 11); let m = v.length > 0 ? "(" + v.substring(0, 2) : ""; if (v.length > 2) m += ") " + v.substring(2, 7); if (v.length > 7) m += "-" + v.substring(7, 11); i.value = m; userZap = m; }

        function checkCoupon(val) {
            if (couponIsValid) return;
            let code = val.toUpperCase().trim();
            if (COUPONS_DB[code]) {
                couponCode = code;
                couponIsValid = true;
                updateSummary();
                renderForm();
            }
        }

        function setExtraDays(d) { extraDays = d; updateSummary(); renderForm(); }
    </script>
</body>
</html>
